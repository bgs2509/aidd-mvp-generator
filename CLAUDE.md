# CLAUDE.md — Главная точка входа для AI-агентов

> **Философия**: VERIFY BEFORE ACT — Проверяй перед действием.
> **Принцип**: Артефакты = Память. Не полагаемся на контекст чата.
>
> Полный список артефактов: [docs/NAVIGATION.md](docs/NAVIGATION.md#сводная-таблица)

---

## TL;DR (30 секунд)

| Вопрос | Ответ |
|--------|-------|
| **Что это?** | Фреймворк для генерации production-ready MVP за ~10 минут |
| **Как работает?** | 9-этапный пайплайн с качественными воротами |
| **Как начать?** | `/aidd-idea "описание проекта"` |
| **Результат** | Работающий MVP: FastAPI + PostgreSQL + Docker |

---

## Что такое AIDD-MVP Generator

**AIDD-MVP Generator** — фреймворк для быстрой генерации production-ready MVP проектов,
объединяющий методологию AI-Driven Development (AIDD) с архитектурными шаблонами.

### Ключевые характеристики

| Параметр | Значение |
|----------|----------|
| Уровень зрелости | **Level 2 (MVP)** — всегда |
| Покрытие тестами | ≥75% |
| Архитектура | DDD/Hexagonal, HTTP-only доступ к данным |
| Качественные ворота | 9 этапов (0-8), 9 ворот |
| Типы сервисов | Business API, Data API, Bot, Worker |

---

## Уникальность: Git Submodule подход

> **КЛЮЧЕВАЯ ИДЕЯ**: Фреймворк ≠ шаблон. Фреймворк = Knowledge Base.

```
┌────────────────────────────────────────────────────────────────────┐
│                    МОДЕЛЬ ИСПОЛЬЗОВАНИЯ                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  my-project/                    ← ЦЕЛЕВОЙ ПРОЕКТ (ваш код)         │
│  │                                                                 │
│  ├── .aidd/                     ← Git Submodule (ТОЛЬКО ЧТЕНИЕ!)   │
│  │   ├── CLAUDE.md              ← Инструкции                       │
│  │   ├── .claude/agents/        ← Роли AI                          │
│  │   ├── .claude/commands/      ← Slash-команды                    │
│  │   ├── templates/             ← Шаблоны сервисов                 │
│  │   └── knowledge/             ← База знаний                      │
│  │                                                                 │
│  ├── ai-docs/docs/              ← AI-ГЕНЕРИРУЕМЫЕ АРТЕФАКТЫ        │
│  │   ├── prd/{name}-prd.md                                         │
│  │   ├── architecture/{name}-plan.md                               │
│  │   └── reports/                                                  │
│  │                                                                 │
│  ├── services/                  ← AI-ГЕНЕРИРУЕМЫЙ КОД              │
│  │   ├── {context}_{domain}_api/                                   │
│  │   └── {context}_{domain}_data/                                  │
│  │                                                                 │
│  ├── .pipeline-state.json       ← Состояние пайплайна              │
│  └── docker-compose.yml         ← Инфраструктура                   │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### Критическое правило

```
┌─────────────────────────────────────────────────────────────────┐
│  ⛔ НИКОГДА НЕ МОДИФИЦИРОВАТЬ ФАЙЛЫ В .aidd/                     │
├─────────────────────────────────────────────────────────────────┤
│  • Фреймворк = Knowledge Base (только чтение)                   │
│  • Весь код генерируется ВОВНЕ submodule                        │
│  • Для обновления: git submodule update --remote                │
└─────────────────────────────────────────────────────────────────┘
```

### Особенности работы с командами

**Проблема**: Claude Code ищет slash-команды только в `{project}/.claude/commands/`.
Когда фреймворк подключен как submodule (`.aidd/`), команды из `.aidd/.claude/commands/`
**не регистрируются автоматически**.

**Решение**: Команда `/aidd-init` автоматически копирует файлы команд:

```bash
# При /aidd-init выполняется:
mkdir -p .claude/commands
cp .aidd/.claude/commands/*.md .claude/commands/
```

После `/aidd-init` команды доступны в автодополнении CLI:
```
/aidd-idea, /aidd-research, /aidd-plan, /aidd-feature-plan, /aidd-generate,
/aidd-review, /aidd-test, /aidd-validate, /aidd-deploy
```

**Обновление команд**: При обновлении submodule (`.aidd/`) повторно запустите `/aidd-init` —
изменённые файлы будут обновлены, существующие актуальные пропущены.

**Как AI выполняет команду**:
```
Пользователь: /aidd-idea "описание"
     ↓
Claude Code загружает: ./.claude/commands/aidd-idea.md (копия из .aidd/)
     ↓
AI читает: ./.aidd/.claude/agents/analyst.md (роль)
     ↓
AI выполняет команду по инструкциям
```

---

## Два режима работы

| Режим | Когда использовать | Отличия |
|-------|-------------------|---------|
| **CREATE** | Новый MVP с нуля | `/aidd-plan` → полная архитектура |
| **FEATURE** | Добавление фичи в существующий проект | `/aidd-feature-plan` → план интеграции |

### Автоопределение режима

| Признак | Режим |
|---------|-------|
| Есть `services/` или `docker-compose.yml` | **FEATURE** |
| Пустая директория | **CREATE** |

Явное переопределение: `/aidd-idea --mode=FEATURE "описание"`

### Параллельные пайплайны (Pipeline State v2)

Фреймворк поддерживает одновременную разработку нескольких фич:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ПАРАЛЛЕЛЬНЫЕ ПАЙПЛАЙНЫ                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  main                                                                   │
│    │                                                                    │
│    ├──┬── feature/F042-oauth ─────────────────────────▶ merge           │
│    │  │     ├── /aidd-idea → PRD_READY                                 │
│    │  │     ├── /aidd-research → RESEARCH_DONE                         │
│    │  │     ├── /aidd-plan → PLAN_APPROVED                             │
│    │  │     └── ... → DEPLOYED                                          │
│    │  │                                                                 │
│    │  └── feature/F043-payments ──────────────────────▶ merge           │
│    │        ├── /aidd-idea (параллельно!)                              │
│    │        └── ...                                                     │
│    ▼                                                                    │
│  main (с обеими фичами)                                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**Ключевые особенности**:
- Каждая фича разрабатывается в отдельной git ветке `feature/{FID}-{slug}`
- Ворота изолированы: `active_pipelines[FID].gates` вместо общих `gates`
- Контекст фичи определяется автоматически по текущей git ветке
- При `/aidd-deploy` фича переносится в `features_registry`

**Документация**: [knowledge/pipeline/git-integration.md](knowledge/pipeline/git-integration.md)

### Режимы инициализации (`/aidd-init`)

Команда `/aidd-init` автоматически определяет тип проекта и запускает соответствующий режим:

| Режим | Условие | Поведение |
|-------|---------|-----------|
| **NEW_PROJECT** | Проект пустой | Стандартная инициализация — создание всех файлов |
| **EXISTING_PROJECT** | Есть значимые файлы | Интерактивный режим — AI спрашивает для каждого файла |

**Критерии существующего проекта** (любой из):
- `services/`, `src/`, `app/` — директории с кодом
- `docker-compose.yml` — инфраструктура
- `CLAUDE.md` — документация проекта
- `README.md` размером > 500 байт
- Более 2 Python файлов в корне

**Интерактивный режим EXISTING_PROJECT**:

```
┌─────────────────────────────────────────────────────────────────┐
│  Для каждого файла/папки AI задаёт вопрос:                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Файл существует и отличается от шаблона:                        │
│  • [1] Сохранить текущую версию (рекомендуется)                 │
│  • [2] Заменить на шаблон                                        │
│  • [3] Объединить (добавить секции из шаблона)                  │
│                                                                  │
│  Файл/папка не существует:                                       │
│  • Создать? [Y/n] или [y/N]                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

Все решения записываются в `.pipeline-state.json`:
```json
{
  "init_mode": "EXISTING_PROJECT",
  "init_decisions": {
    "CLAUDE.md": "kept_existing",
    "README.md": "kept_existing",
    ".pipeline-state.json": "created",
    "ai-docs/": "skipped"
  }
}
```

---

## 9-этапный пайплайн

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PIPELINE (этапы 0-8)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────┐                                                         │
│  │/aidd-init  │ Этап 0: Bootstrap                                       │
│  └─────┬──────┘                                                         │
│        │ BOOTSTRAP_READY                                                │
│        ▼                                                                │
│  ┌────────────┐  ┌──────────────┐  ┌───────────┐  ┌──────────────┐     │
│  │/aidd-idea  │─▶│/aidd-research│─▶│/aidd-plan │─▶│/aidd-generate│     │
│  │  Этап 1    │  │   Этап 2     │  │  Этап 3   │  │   Этап 4     │     │
│  └─────┬──────┘  └──────┬───────┘  └─────┬─────┘  └──────┬───────┘     │
│        │                │                │               │              │
│  PRD_READY       RESEARCH_DONE     PLAN_APPROVED   IMPLEMENT_OK        │
│                                          ⚠️                             │
│                                 Требует подтверждения                   │
│                                    пользователя!                        │
│                                                                         │
│  ┌──────────────┐  ┌───────────┐  ┌───────────────┐  ┌─────────────┐   │
│  │/aidd-review  │─▶│/aidd-test │─▶│/aidd-validate │─▶│/aidd-deploy │   │
│  │   Этап 5     │  │  Этап 6   │  │    Этап 7     │  │   Этап 8    │   │
│  └──────┬───────┘  └─────┬─────┘  └───────┬───────┘  └──────┬──────┘   │
│       │               │               │               │                 │
│  REVIEW_OK        QA_PASSED     ALL_GATES_PASSED   DEPLOYED            │
│                   (≥75% cov)                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Таблица команд и ворот

| # | Этап | Команда | Агент | Ворота | Артефакт |
|---|------|---------|-------|--------|----------|
| 0 | Bootstrap | `/aidd-init` | — | `BOOTSTRAP_READY` | Структура ЦП |
| 1 | Идея | `/aidd-idea` | Аналитик | `PRD_READY` | `prd/{name}-prd.md` |
| 2 | Исследование | `/aidd-research` | Исследователь | `RESEARCH_DONE` | `research/{name}-research.md` |
| 3 | Архитектура (CREATE) | `/aidd-plan` | Архитектор | `PLAN_APPROVED` | `architecture/{name}-plan.md` |
| 3 | Архитектура (FEATURE) | `/aidd-feature-plan` | Архитектор | `PLAN_APPROVED` | `plans/{feature}-plan.md` |
| 4 | Реализация | `/aidd-generate` | Реализатор | `IMPLEMENT_OK` | `services/`, тесты |
| 5 | Ревью | `/aidd-review` | Ревьюер | `REVIEW_OK` | `reports/review-report.md` |
| 6 | QA | `/aidd-test` | QA | `QA_PASSED` | `reports/qa-report.md` |
| 7 | Валидация | `/aidd-validate` | Валидатор | `ALL_GATES_PASSED` | `rtm.md` |
| 8 | Деплой | `/aidd-deploy` | Валидатор | `DEPLOYED` | Работающее приложение |

> Файлы команд: [docs/INDEX.md](docs/INDEX.md#slash-команды)

### Принцип блокировки

```
❌ Ворота не пройдены → Переход на следующий этап ЗАБЛОКИРОВАН
✅ Ворота пройдены → Можно продолжать
```

**Пример**: Нельзя выполнить `/aidd-generate` без `PLAN_APPROVED`.

---

## 7 ролей AI-агентов

| Роль | Файл | Этапы | Ответственность |
|------|------|-------|-----------------|
| **Аналитик** | `.claude/agents/analyst.md` | 1 | PRD, требования |
| **Исследователь** | `.claude/agents/researcher.md` | 2 | Анализ кода/требований |
| **Архитектор** | `.claude/agents/architect.md` | 3 | Проектирование |
| **Реализатор** | `.claude/agents/implementer.md` | 4 | Генерация кода |
| **Ревьюер** | `.claude/agents/reviewer.md` | 5 | Качество кода |
| **QA** | `.claude/agents/qa.md` | 6 | Тестирование |
| **Валидатор** | `.claude/agents/validator.md` | 7-8 | Финальная проверка, деплой |

---

## Взаимодействие пользователя с фреймворком

```
┌─────────────────────────────────────────────────────────────────────┐
│  ПОЛЬЗОВАТЕЛЬ                           AI-АГЕНТ                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. Подключает .aidd/ как submodule                                 │
│  2. Запускает Claude Code                                           │
│                                                                     │
│  3. /aidd-idea "описание"       ───▶    Создаёт PRD                 │
│                                         Задаёт уточняющие вопросы   │
│                                                                     │
│  4. Отвечает на вопросы         ◀───    PRD_READY ✓                 │
│                                                                     │
│  5. /aidd-research              ───▶    Анализирует                 │
│                                         RESEARCH_DONE ✓             │
│                                                                     │
│  6. /aidd-plan                  ───▶    Создаёт план архитектуры    │
│                                                                     │
│  7. ⚠️ УТВЕРЖДАЕТ ПЛАН          ◀───    Ждёт подтверждения          │
│     "Да, план утверждаю"                PLAN_APPROVED ✓             │
│                                                                     │
│  8. /aidd-generate              ───▶    Генерирует код              │
│                                         IMPLEMENT_OK ✓              │
│                                                                     │
│  9. /aidd-review → /aidd-test   ───▶    Проверяет качество          │
│     → /aidd-validate                    ALL_GATES_PASSED ✓          │
│                                                                     │
│  10. /aidd-deploy               ───▶    Запускает приложение        │
│                                         DEPLOYED ✓                  │
│                                                                     │
│  🎉 MVP готов!                                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Архитектурные принципы

| Принцип | Правило |
|---------|---------|
| **HTTP-only** | Бизнес-сервисы НИКОГДА не обращаются к БД напрямую. Только через Data API. |
| **DDD/Hexagonal** | Разделение на `api/application/domain/infrastructure` |
| **Async-First** | Все I/O операции используют `async/await` |
| **Типобезопасность** | Полные type hints для всех функций |
| **Level 2 (MVP)** | Готов к продакшену, но без сложной масштабируемости |

### HTTP-only архитектура

```
┌─────────────┐      HTTP       ┌─────────────┐      SQL      ┌─────────┐
│ Business API│ ──────────────▶ │  Data API   │ ────────────▶ │   БД    │
│  (FastAPI)  │                 │  (FastAPI)  │               │(Postgres)│
└─────────────┘                 └─────────────┘               └─────────┘
      ▲
      │ HTTP
      │
┌─────────────┐
│  Telegram   │
│    Bot      │
└─────────────┘
```

---

## Критические правила (VERIFY BEFORE ACT)

```
┌─────────────────────────────────────────────────────────────────┐
│  ПЕРЕД ЛЮБЫМ ДЕЙСТВИЕМ AI ОБЯЗАН:                               │
├─────────────────────────────────────────────────────────────────┤
│  1. СОЗДАНИЕ ФАЙЛА  → Проверить, что файл НЕ существует         │
│  2. РЕДАКТИРОВАНИЕ  → Сначала прочитать текущее содержимое      │
│  3. УДАЛЕНИЕ        → Проверить все зависимости и ссылки        │
│  4. ДОБАВЛЕНИЕ ССЫЛКИ → Проверить, что цель существует          │
│  5. НАПИСАНИЕ КОДА  → Проверить нет ли похожего кода (DRY)      │
│  6. ДОБАВЛЕНИЕ ФИЧИ → Проверить, что это нужно СЕЙЧАС (YAGNI)   │
└─────────────────────────────────────────────────────────────────┘

НИКОГДА НЕ ПРЕДПОЛАГАТЬ → ВСЕГДА ПРОВЕРЯТЬ → ЗАТЕМ ДЕЙСТВОВАТЬ
```

---

## Порядок чтения для AI-агента

### При работе в целевом проекте (ЦП)

```
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 1: Контекст целевого проекта (СНАЧАЛА!)                       │
├─────────────────────────────────────────────────────────────────────┤
│  1. ./CLAUDE.md              ← Точка входа ЦП                       │
│  2. ./.pipeline-state.json   ← Состояние, режим, пройденные ворота  │
│  3. ./ai-docs/docs/          ← Существующие артефакты               │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 2: Проверка предусловий                                       │
├─────────────────────────────────────────────────────────────────────┤
│  4. Проверить требуемые ворота для команды                          │
│  5. Если не пройдены → сообщить пользователю                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 3: Инструкции фреймворка                                      │
├─────────────────────────────────────────────────────────────────────┤
│  6. .aidd/workflow.md        ← Процесс и ворота                     │
│  7. .aidd/.claude/commands/  ← Инструкции команды                   │
│  8. .aidd/.claude/agents/    ← Инструкции роли                      │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 4: Шаблоны (только если артефакт НЕ существует)               │
├─────────────────────────────────────────────────────────────────────┤
│  9. .aidd/templates/documents/  ← Шаблоны документов                │
│  10. .aidd/knowledge/           ← База знаний по теме               │
└─────────────────────────────────────────────────────────────────────┘
```

**Подробный алгоритм**: [docs/initialization.md](docs/initialization.md)

### При разработке самого фреймворка

```
CLAUDE.md → docs/INDEX.md → conventions.md → workflow.md
```

---

## Быстрый старт

### Новый проект (CREATE)

```bash
# 1. Создать проект и подключить фреймворк
mkdir my-mvp && cd my-mvp
git init
git submodule add https://github.com/your-org/aidd-mvp-generator.git .aidd

# 2. Запустить Claude Code
claude

# 3. Начать работу
/aidd-idea "Создать сервис бронирования столиков в ресторанах"

# 4. Следовать пайплайну (этапы 0-8)
# /aidd-init → /aidd-idea → /aidd-research → /aidd-plan → /aidd-generate → /aidd-review → /aidd-test → /aidd-validate → /aidd-deploy
```

### Добавление фичи (FEATURE)

```bash
cd existing-project
claude
/aidd-idea "Добавить систему email уведомлений"

# /aidd-idea → /aidd-research → /aidd-feature-plan → /aidd-generate → /aidd-review → /aidd-test → /aidd-validate → /aidd-deploy
```

---

## Типы генерируемых сервисов

| Тип | Шаблон | Порт | Описание |
|-----|--------|------|----------|
| **Business API** | `fastapi_business_api/` | 8000-8099 | REST API на FastAPI |
| **Data API (PostgreSQL)** | `postgres_data_api/` | 8001 | CRUD для PostgreSQL |
| **Data API (MongoDB)** | `mongo_data_api/` | 8002 | CRUD для MongoDB |
| **Telegram Bot** | `aiogram_bot/` | — | Бот на Aiogram |
| **Background Worker** | `asyncio_worker/` | — | Фоновые задачи |

### Именование сервисов

```
{контекст}_{домен}_{тип}

Примеры:
- finance_lending_api      — Business API
- finance_lending_data     — Data API
- finance_lending_bot      — Telegram Bot
```

---

## Структура фреймворка

```
aidd-mvp-generator/
│
├── CLAUDE.md              ← ВЫ ЗДЕСЬ — точка входа
├── conventions.md         ← Соглашения о коде и стиле
├── workflow.md            ← Описание 9-этапного процесса
│
├── .claude/               ← Интеграция Claude Code
│   ├── settings.json      ← Permissions и hooks (коммитится)
│   ├── settings.local.json← Локальные permissions (НЕ коммитить!)
│   ├── agents/            ← 7 ролей AI-агентов
│   └── commands/          ← 10 slash-команд
│
├── roles/                 ← Детальные инструкции по ролям
├── knowledge/             ← База знаний (архитектура, сервисы, качество)
├── templates/             ← Шаблоны (сервисы, документы, инфраструктура)
└── docs/                  ← Документация генератора
```

**Полный индекс**: [docs/INDEX.md](docs/INDEX.md)

---

## Навигация по документации

| Ищу | Документ |
|-----|----------|
| Полный индекс файлов | [docs/INDEX.md](docs/INDEX.md) |
| Навигационная матрица | [docs/NAVIGATION.md](docs/NAVIGATION.md) |
| Алгоритм инициализации | [docs/initialization.md](docs/initialization.md) |
| 9-этапный процесс | [workflow.md](workflow.md) |
| Соглашения о коде | [conventions.md](conventions.md) |
| Структура целевого проекта | [docs/target-project-structure.md](docs/target-project-structure.md) |
| **Параллельные пайплайны** | [knowledge/pipeline/git-integration.md](knowledge/pipeline/git-integration.md) |
| Pipeline State v2 | [knowledge/pipeline/state-v2.md](knowledge/pipeline/state-v2.md) |
| Инструкции роли | `.claude/agents/{role}.md` |
| Инструкции команды | `.claude/commands/{command}.md` |
| Шаблоны документов | `templates/documents/*.md` |
| Шаблоны сервисов | `templates/services/*/` |
| База знаний | `knowledge/` |

---

**Версия документа**: 2.3
**Обновлён**: 2025-12-25
**Назначение**: Главная точка входа для AI-агентов AIDD-MVP Generator
