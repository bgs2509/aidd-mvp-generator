# workflow.md — Процесс разработки AIDD-MVP

> **Назначение**: Описание 8-этапного процесса разработки MVP.
> AI-агент ОБЯЗАН следовать этому процессу и проходить качественные ворота.
>
> **Философия**: Артефакты = Память. Не полагаемся на память чата.

---

## Обзор процесса

AIDD-MVP Generator использует 8-этапный конвейер разработки с обязательными
качественными воротами между этапами. Переход на следующий этап возможен
ТОЛЬКО после прохождения ворот текущего этапа.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     AIDD-MVP DEVELOPMENT PIPELINE                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐              │
│  │  ИДЕЯ   │───▶│ИССЛЕДО- │───▶│АРХИТЕК- │───▶│РЕАЛИЗА- │              │
│  │         │    │ ВАНИЕ   │    │  ТУРА   │    │   ЦИЯ   │              │
│  └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘              │
│       │              │              │              │                    │
│  ┌────▼────┐    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐              │
│  │PRD_READY│    │RESEARCH │    │  PLAN   │    │IMPLEMENT│              │
│  │         │    │  _DONE  │    │APPROVED │    │   _OK   │              │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘              │
│                                                                          │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐              │
│  │  РЕВЬЮ  │───▶│   QA    │───▶│ВАЛИДА-  │───▶│ ДЕПЛОЙ  │              │
│  │         │    │         │    │   ЦИЯ   │    │         │              │
│  └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘              │
│       │              │              │              │                    │
│  ┌────▼────┐    ┌────▼────┐    ┌────▼────┐    ┌────▼────┐              │
│  │ REVIEW  │    │   QA    │    │ALL_GATES│    │DEPLOYED │              │
│  │   _OK   │    │ PASSED  │    │ PASSED  │    │         │              │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Два режима работы

### CREATE — Создание нового MVP

Полный 8-этапный процесс для создания проекта с нуля.

```bash
/idea "Создать сервис бронирования столиков в ресторанах"
```

### FEATURE — Добавление функционала

Адаптированный процесс для добавления фичи в существующий проект.

```bash
/idea "Добавить систему уведомлений по email"
```

**Отличия режима FEATURE**:
- Этап 2 (Исследование) — анализ существующего кода
- Этап 3 (Архитектура) — `/feature-plan` вместо `/plan`
- Интеграция с существующими компонентами

---

## Bootstrap: Инициализация целевого проекта

> **ВАЖНО**: Артефакты создаются в ЦЕЛЕВОМ ПРОЕКТЕ, не в генераторе!
> Подробнее: [docs/target-project-structure.md](docs/target-project-structure.md)

### Автоматическая инициализация при `/idea`

При первом запуске `/idea` AI-агент выполняет:

```bash
# 1. Создание структуры артефактов
mkdir -p ai-docs/docs/{prd,architecture,plans,reports}

# 2. Инициализация состояния пайплайна
cat > .pipeline-state.json << 'EOF'
{
  "project_name": "",
  "mode": "CREATE",
  "current_stage": 1,
  "gates": {}
}
EOF
```

### Определение режима

| Признак | Режим |
|---------|-------|
| Есть `services/` или `docker-compose.yml` | **FEATURE** |
| Пустая директория или нет признаков проекта | **CREATE** |

---

## Этапы процесса

### Этап 1: Идея → PRD

| Параметр | Значение |
|----------|----------|
| **Команда** | `/idea "описание"` |
| **Агент** | Аналитик |
| **Вход** | Описание идеи от пользователя |
| **Выход** | `ai-docs/docs/prd/{name}-prd.md` |
| **Ворота** | `PRD_READY` |

**Критерии прохождения ворот PRD_READY**:
- [ ] Все секции PRD заполнены
- [ ] Требования имеют ID (FR-*, NF-*, UI-*)
- [ ] Определены критерии приёмки
- [ ] Нет блокирующих открытых вопросов

**Артефакты** (в целевом проекте):
```
{project-name}/
└── ai-docs/docs/prd/
    └── booking-restaurant-prd.md
```

---

### Этап 2: Исследование

| Параметр | Значение |
|----------|----------|
| **Команда** | `/research` |
| **Агент** | Исследователь |
| **Вход** | PRD, существующий код (для FEATURE) |
| **Выход** | Анализ, выявленные паттерны |
| **Ворота** | `RESEARCH_DONE` |

**Критерии прохождения ворот RESEARCH_DONE**:
- [ ] Существующий код проанализирован (для FEATURE)
- [ ] Архитектурные паттерны выявлены
- [ ] Технические ограничения определены
- [ ] Рекомендации по интеграции сформулированы

**Режим CREATE**: Анализ требований, выбор технологий.
**Режим FEATURE**: Анализ кода, выявление точек расширения.

---

### Этап 3: Архитектура

| Параметр | Значение |
|----------|----------|
| **Команда** | `/plan` (CREATE) или `/feature-plan` (FEATURE) |
| **Агент** | Архитектор |
| **Вход** | PRD, результаты исследования |
| **Выход** | `ai-docs/docs/architecture/{name}-plan.md` |
| **Ворота** | `PLAN_APPROVED` |

**Критерии прохождения ворот PLAN_APPROVED**:
- [ ] Компоненты системы описаны
- [ ] API контракты определены
- [ ] NFR (нефункциональные требования) учтены
- [ ] **План утверждён пользователем**

**Важно**: Этот этап ТРЕБУЕТ явного подтверждения от пользователя!

**Артефакты** (в целевом проекте):
```
{project-name}/
└── ai-docs/docs/
    ├── architecture/
    │   └── booking-restaurant-plan.md
    └── plans/
        └── notification-feature-plan.md  # для FEATURE
```

---

### Этап 4: Реализация

| Параметр | Значение |
|----------|----------|
| **Команда** | `/generate` |
| **Агент** | Реализатор |
| **Вход** | Утверждённый план |
| **Выход** | Код сервисов, тесты, инфраструктура |
| **Ворота** | `IMPLEMENT_OK` |

**Критерии прохождения ворот IMPLEMENT_OK**:
- [ ] Код написан согласно плану
- [ ] Все unit-тесты проходят
- [ ] Структура соответствует DDD/Hexagonal
- [ ] Type hints и docstrings присутствуют

**Подэтапы реализации**:

| # | Подэтап | Выход |
|---|---------|-------|
| 4.1 | Инфраструктура | docker-compose, Makefile, CI/CD |
| 4.2 | Data Service | API для работы с БД |
| 4.3 | Business API | REST API на FastAPI |
| 4.4 | Background Worker | Фоновые задачи (если нужен) |
| 4.5 | Telegram Bot | Бот (если нужен) |
| 4.6 | Тесты | Unit + Integration тесты |

---

### Этап 5: Ревью

| Параметр | Значение |
|----------|----------|
| **Команда** | `/review` |
| **Агент** | Ревьюер |
| **Вход** | Сгенерированный код |
| **Выход** | `ai-docs/docs/reports/review-report.md` |
| **Ворота** | `REVIEW_OK` |

**Критерии прохождения ворот REVIEW_OK**:
- [ ] Код соответствует conventions.md
- [ ] Архитектура соответствует плану
- [ ] Нет критических замечаний
- [ ] DRY/KISS/YAGNI соблюдены

**Артефакты** (в целевом проекте):
```
{project-name}/
└── ai-docs/docs/reports/
    └── review-report.md
```

---

### Этап 6: QA

| Параметр | Значение |
|----------|----------|
| **Команда** | `/test` |
| **Агент** | QA |
| **Вход** | Код после ревью |
| **Выход** | `ai-docs/docs/reports/qa-report.md` |
| **Ворота** | `QA_PASSED` |

**Критерии прохождения ворот QA_PASSED**:
- [ ] Покрытие тестами ≥75%
- [ ] Все тесты проходят
- [ ] Нет критических багов
- [ ] Требования из PRD проверены

**Артефакты** (в целевом проекте):
```
{project-name}/
└── ai-docs/docs/reports/
    └── qa-report.md
```

---

### Этап 7: Валидация

| Параметр | Значение |
|----------|----------|
| **Команда** | `/validate` |
| **Агент** | Валидатор |
| **Вход** | Все артефакты проекта |
| **Выход** | `ai-docs/docs/reports/validation-report.md` |
| **Ворота** | `ALL_GATES_PASSED` |

**Критерии прохождения ворот ALL_GATES_PASSED**:
- [ ] Все предыдущие ворота пройдены
- [ ] Артефакты соответствуют требованиям
- [ ] RTM (Requirements Traceability Matrix) актуальна
- [ ] Проект готов к деплою

**Артефакты** (в целевом проекте):
```
{project-name}/
└── ai-docs/docs/
    ├── reports/
    │   └── validation-report.md
    └── rtm.md  # Матрица трассировки требований
```

---

### Этап 8: Деплой

| Параметр | Значение |
|----------|----------|
| **Команда** | `/deploy` |
| **Агент** | Валидатор |
| **Вход** | Валидированный проект |
| **Выход** | Работающее приложение |
| **Ворота** | `DEPLOYED` |

**Критерии прохождения ворот DEPLOYED**:
- [ ] Docker-контейнеры собраны
- [ ] Приложение запущено
- [ ] Health-check проходит
- [ ] Базовые сценарии работают

**Команды деплоя**:
```bash
# Сборка и запуск
make build
make up

# Проверка
make health
make logs
```

---

## Таблица команд и ворот

| # | Этап | Команда | Агент | Ворота |
|---|------|---------|-------|--------|
| 1 | Идея | `/idea` | Аналитик | `PRD_READY` |
| 2 | Исследование | `/research` | Исследователь | `RESEARCH_DONE` |
| 3 | Архитектура | `/plan` | Архитектор | `PLAN_APPROVED` |
| 4 | Реализация | `/generate` | Реализатор | `IMPLEMENT_OK` |
| 5 | Ревью | `/review` | Ревьюер | `REVIEW_OK` |
| 6 | QA | `/test` | QA | `QA_PASSED` |
| 7 | Валидация | `/validate` | Валидатор | `ALL_GATES_PASSED` |
| 8 | Деплой | `/deploy` | Валидатор | `DEPLOYED` |

---

## Артефакты по этапам (в целевом проекте)

> **ВАЖНО**: Все артефакты создаются в ЦЕЛЕВОМ ПРОЕКТЕ, не в генераторе!

```
{project-name}/                      ← Целевой проект
│
├── .pipeline-state.json             # Состояние пайплайна
│
└── ai-docs/docs/
    ├── prd/
    │   └── {name}-prd.md            # Этап 1: PRD документ
    │
    ├── architecture/
    │   └── {name}-plan.md           # Этап 3: Архитектурный план
    │
    ├── plans/
    │   └── {feature}-plan.md        # Этап 3: План фичи (FEATURE)
    │
    ├── reports/
    │   ├── review-report.md         # Этап 5: Отчёт ревью
    │   ├── qa-report.md             # Этап 6: Отчёт QA
    │   └── validation-report.md     # Этап 7: Отчёт валидации
    │
    └── rtm.md                       # Матрица трассировки требований
```

---

## Пример полного прохода (режим CREATE)

```bash
# 1. Описываем идею
/idea "Создать сервис бронирования столиков в ресторанах.
Пользователи могут искать рестораны, смотреть свободные столики,
бронировать на определённое время. Рестораны получают уведомления
о новых бронях через Telegram."

# Агент: Аналитик создаёт PRD
# Ворота: PRD_READY ✓

# 2. Исследование
/research

# Агент: Исследователь анализирует требования
# Ворота: RESEARCH_DONE ✓

# 3. Архитектура
/plan

# Агент: Архитектор создаёт план
# Пользователь утверждает план
# Ворота: PLAN_APPROVED ✓

# 4. Реализация
/generate

# Агент: Реализатор генерирует код
# Создаются: infrastructure, data-api, business-api, bot
# Ворота: IMPLEMENT_OK ✓

# 5. Ревью
/review

# Агент: Ревьюер проверяет код
# Ворота: REVIEW_OK ✓

# 6. QA
/test

# Агент: QA запускает тесты
# Coverage: 78% ✓
# Ворота: QA_PASSED ✓

# 7. Валидация
/validate

# Агент: Валидатор проверяет все артефакты
# Ворота: ALL_GATES_PASSED ✓

# 8. Деплой
/deploy

# Агент: Запускает docker-compose
# Ворота: DEPLOYED ✓

# Готово! MVP запущен за ~10 минут
```

---

## Состояние пайплайна (.pipeline-state.json)

> **Философия**: Артефакты = Память. Состояние пайплайна — единый источник истины.

### Формат файла

Файл `.pipeline-state.json` создаётся в корне ЦЕЛЕВОГО ПРОЕКТА при первом `/idea`.

```json
{
  "project_name": "booking-service",
  "mode": "CREATE",
  "current_stage": 4,
  "created_at": "2025-12-21T10:00:00Z",
  "updated_at": "2025-12-21T10:30:00Z",
  "gates": {
    "PRD_READY": {"passed": true, "artifact": "ai-docs/docs/prd/booking-prd.md"},
    "PLAN_APPROVED": {"passed": true, "artifact": "ai-docs/docs/architecture/booking-plan.md"}
  },
  "artifacts": {
    "prd": "ai-docs/docs/prd/booking-prd.md",
    "plan": "ai-docs/docs/architecture/booking-plan.md"
  }
}
```

**Шаблон**: [docs/templates/pipeline-state-template.json](docs/templates/pipeline-state-template.json)

### Обновление состояния

Каждая команда ОБЯЗАНА обновить `.pipeline-state.json`:
1. При старте — проверить предусловия
2. При успехе — отметить ворота пройденными
3. При создании артефакта — записать путь

---

## Алгоритм обнаружения артефактов

Команды используют следующий алгоритм для поиска входных артефактов:

```python
def find_artifact(artifact_type: str) -> Path | None:
    """
    Алгоритм поиска артефакта в целевом проекте.

    Args:
        artifact_type: 'prd', 'plan', 'feature_plan', 'review_report', etc.

    Returns:
        Path к артефакту или None
    """
    # 1. Проверить .pipeline-state.json
    state = read_json(".pipeline-state.json")
    if state and state.get("artifacts", {}).get(artifact_type):
        return Path(state["artifacts"][artifact_type])

    # 2. Glob по стандартным паттернам
    patterns = {
        "prd": "ai-docs/docs/prd/*-prd.md",
        "plan": "ai-docs/docs/architecture/*-plan.md",
        "feature_plan": "ai-docs/docs/plans/*-plan.md",
        "review_report": "ai-docs/docs/reports/review-*.md",
        "qa_report": "ai-docs/docs/reports/qa-*.md",
        "rtm": "ai-docs/docs/rtm.md"
    }

    files = glob(patterns.get(artifact_type, ""))
    if files:
        # Вернуть самый свежий
        return max(files, key=lambda f: f.stat().st_mtime)

    return None
```

### Паттерны поиска

| Артефакт | Паттерн | Суффикс |
|----------|---------|---------|
| PRD | `ai-docs/docs/prd/*-prd.md` | `-prd.md` |
| План архитектуры | `ai-docs/docs/architecture/*-plan.md` | `-plan.md` |
| План фичи | `ai-docs/docs/plans/*-plan.md` | `-plan.md` |
| Отчёт ревью | `ai-docs/docs/reports/review-*.md` | `review-*.md` |
| Отчёт QA | `ai-docs/docs/reports/qa-*.md` | `qa-*.md` |
| RTM | `ai-docs/docs/rtm.md` | — |

---

## Проверка предусловий (Gate Check)

Каждая команда ОБЯЗАНА проверить предусловия перед выполнением:

```python
def check_preconditions(command: str) -> bool:
    """Проверка предусловий перед выполнением команды."""

    preconditions = {
        "/idea": [],  # Нет предусловий
        "/research": ["PRD_READY"],
        "/plan": ["PRD_READY", "RESEARCH_DONE"],
        "/feature-plan": ["PRD_READY", "RESEARCH_DONE"],
        "/generate": ["PLAN_APPROVED"],
        "/review": ["IMPLEMENT_OK"],
        "/test": ["REVIEW_OK"],
        "/validate": ["QA_PASSED"],
        "/deploy": ["ALL_GATES_PASSED"]
    }

    state = read_json(".pipeline-state.json")
    if not state:
        return command == "/idea"

    for gate in preconditions.get(command, []):
        if not state.get("gates", {}).get(gate, {}).get("passed"):
            print(f"❌ Ворота {gate} не пройдены")
            return False

    return True
```

### Матрица предусловий

| Команда | Требуемые ворота | Если не пройдены |
|---------|-----------------|------------------|
| `/idea` | — | — |
| `/research` | PRD_READY | "Сначала выполните /idea" |
| `/plan` | PRD_READY, RESEARCH_DONE | "Сначала выполните /research" |
| `/feature-plan` | PRD_READY, RESEARCH_DONE | "Сначала выполните /research" |
| `/generate` | PLAN_APPROVED | "Сначала утвердите план" |
| `/review` | IMPLEMENT_OK | "Сначала выполните /generate" |
| `/test` | REVIEW_OK | "Сначала выполните /review" |
| `/validate` | QA_PASSED | "Сначала выполните /test" |
| `/deploy` | ALL_GATES_PASSED | "Сначала выполните /validate" |

---

## Правила прохождения ворот

### 1. Блокирующие ворота

AI-агент **НЕ МОЖЕТ** перейти к следующему этапу, если ворота не пройдены.

```
❌ PRD_READY не пройден → /plan заблокирована
❌ PLAN_APPROVED не пройден → /generate заблокирована
```

### 2. Откат при неудаче

Если ворота не пройдены, нужно исправить проблемы и повторить проверку.

```
/validate
→ ❌ QA_PASSED: Coverage 68% (требуется ≥75%)
→ Добавить тесты
/test
→ ✓ QA_PASSED: Coverage 76%
/validate
→ ✓ ALL_GATES_PASSED
```

### 3. Явное подтверждение пользователя

Некоторые ворота требуют явного подтверждения:

| Ворота | Требует подтверждения |
|--------|----------------------|
| `PRD_READY` | Нет (автоматическая проверка) |
| `PLAN_APPROVED` | **ДА** (пользователь должен утвердить план) |
| `REVIEW_OK` | Нет (автоматическая проверка) |
| `QA_PASSED` | Нет (автоматическая проверка) |
| `DEPLOYED` | Нет (автоматическая проверка) |

---

## Связанные документы

| Документ | Описание |
|----------|----------|
| [CLAUDE.md](CLAUDE.md) | Главная точка входа |
| [conventions.md](conventions.md) | Соглашения о коде |
| [.claude/agents/](/.claude/agents/) | Определения AI-ролей |
| [.claude/commands/](/.claude/commands/) | Определения команд |

---

**Версия документа**: 1.0
**Создан**: 2025-12-19
**Назначение**: Процесс разработки AIDD-MVP Generator
