---
# === YAML Frontmatter (машиночитаемые метаданные) ===
feature_id: "{FID}"
feature_name: "{slug}"
title: "Feature Plan: {Название фичи}"
created: "{YYYY-MM-DD}"
author: "AI (Architect)"
type: "feature-plan"
status: "PLAN_APPROVED"
version: 1
mode: "FEATURE"

# Ссылки на связанные артефакты
prd_ref: "prd/{YYYY-MM-DD}_{FID}_{slug}-prd.md"
research_ref: "research/{YYYY-MM-DD}_{FID}_{slug}-research.md"

# Затрагиваемые сервисы
affected_services:
  modified: []                         # Существующие сервисы для модификации
  created: []                          # Новые сервисы для создания

# Опционально
related_features: []
approved_by: null
approved_at: null
---

# План интеграции фичи: {Название фичи}

**Feature ID**: {FID}
**Версия**: 1.0
**Дата**: {YYYY-MM-DD}
**Автор**: AI Agent (Архитектор)
**Статус**: Draft | Review | Approved
**Режим**: FEATURE
**Связанный PRD**: {prd-name}-prd.md

---

## 1. Обзор фичи

### 1.1 Цель

{Краткое описание что будет добавлено в существующий проект}

### 1.2 Scope

**В scope:**
- {Что включено 1}
- {Что включено 2}
- {Что включено 3}

**Вне scope:**
- {Что исключено 1}
- {Что исключено 2}

---

## 2. Анализ существующей архитектуры

### 2.1 Текущая структура проекта

```
{project_name}/
├── services/
│   ├── {existing_service_1}/    ← Будет модифицирован
│   ├── {existing_service_2}/    ← Без изменений
│   └── {new_service}/           ← Будет создан (если нужно)
├── docker-compose.yml           ← Будет модифицирован
└── ...
```

### 2.2 Затрагиваемые сервисы

| Сервис | Тип изменения | Влияние |
|--------|--------------|---------|
| {service_1} | Модификация | Высокое |
| {service_2} | Без изменений | — |
| {new_service} | Создание | — |

### 2.3 Существующие паттерны

**Архитектурные паттерны в проекте:**
- {Паттерн 1, например: HTTP-only доступ к данным}
- {Паттерн 2, например: DDD/Hexagonal структура}
- {Паттерн 3, например: Async-first подход}

**Соглашения о коде:**
- {Соглашение 1}
- {Соглашение 2}

**Важно**: Новый код ДОЛЖЕН следовать существующим паттернам.

---

## 3. Матрица влияния

### 3.1 Влияние на существующие компоненты

| Компонент | Тип влияния | Риск | Описание |
|-----------|-------------|------|----------|
| {Модель данных X} | Расширение | Низкий | Добавление новых полей |
| {API endpoint Y} | Модификация | Средний | Изменение response |
| {Сервис Z} | Без изменений | — | Не затрагивается |

### 3.2 Зависимости

| Зависимость | Тип | Статус | Действие |
|-------------|-----|--------|----------|
| {Существующий сервис} | Внутренняя | Ready | Использовать существующий API |
| {Внешний API} | Внешняя | Pending | Настроить интеграцию |
| {Новая библиотека} | Пакет | Pending | Добавить в requirements.txt |

### 3.3 Обратная совместимость

| Аспект | Совместим? | Действие если нет |
|--------|------------|-------------------|
| API контракты | Да/Нет | {Действие} |
| Схема БД | Да/Нет | {Миграция} |
| Конфигурация | Да/Нет | {Обновить .env.example} |

---

## 4. План интеграции

### Stage 4.1: Подготовка инфраструктуры (если требуется)

**Цель**: Подготовить окружение для новой фичи

**Задачи**:

| # | Задача | Файлы | Изменение |
|---|--------|-------|-----------|
| 4.1.1 | Обновить docker-compose.yml | docker-compose.yml | Добавить сервис |
| 4.1.2 | Обновить .env.example | .env.example | Новые переменные |
| 4.1.3 | Обновить requirements.txt | requirements.txt | Новые зависимости |

**Критерии завершения**:
- [ ] `docker compose up` запускается без ошибок
- [ ] Все существующие сервисы работают
- [ ] Новые переменные окружения документированы

---

### Stage 4.2: Расширение Data API

**Цель**: Добавить новые модели данных или расширить существующие

**Задачи**:

| # | Задача | Файлы | Требование |
|---|--------|-------|------------|
| 4.2.1 | Создать/расширить модели | domain/entities/{entity}.py | FR-* |
| 4.2.2 | Создать миграцию | alembic/versions/{xxx}_add_{feature}.py | — |
| 4.2.3 | Расширить репозиторий | repositories/{entity}_repository.py | — |
| 4.2.4 | Добавить/расширить endpoints | api/v1/{entity}.py | FR-* |
| 4.2.5 | Написать тесты | tests/unit/test_{entity}.py | — |

**Изменения в моделях**:

```python
# Расширение существующей модели
class {Entity}(Base):
    # Существующие поля...

    # Новые поля для фичи:
    {new_field_1}: Mapped[str | None] = mapped_column(String(255))
    {new_field_2}: Mapped[int] = mapped_column(default=0)
```

**Новые/изменённые endpoints**:

```
# Новые endpoints:
GET    /api/v1/{entities}/{id}/{feature}    → Получить данные фичи
POST   /api/v1/{entities}/{id}/{feature}    → Создать данные фичи

# Изменённые endpoints:
GET    /api/v1/{entities}/{id}              → Добавлен {feature} в response
```

**Критерии завершения**:
- [ ] Миграция применяется успешно (up и down)
- [ ] Существующие тесты НЕ сломаны
- [ ] Новые тесты покрывают новый функционал
- [ ] Coverage ≥ 75%

---

### Stage 4.3: Расширение Business API

**Цель**: Добавить бизнес-логику для фичи

**Задачи**:

| # | Задача | Файлы | Требование |
|---|--------|-------|------------|
| 4.3.1 | Расширить HTTP клиент | infrastructure/http/data_client.py | — |
| 4.3.2 | Создать новый domain service | domain/services/{feature}_service.py | FR-* |
| 4.3.3 | Создать application service | application/services/{feature}_service.py | FR-* |
| 4.3.4 | Добавить API endpoints | api/v1/{feature}.py | FR-* |
| 4.3.5 | Добавить схемы валидации | schemas/{feature}.py | — |
| 4.3.6 | Написать тесты | tests/unit/test_{feature}_service.py | — |

**Бизнес-логика фичи**:

```python
# {Feature}Service
class {Feature}Service:
    def __init__(self, data_client: DataAPIClient):
        self._data_client = data_client

    async def {operation}(self, request: {Feature}Request) -> {Feature}Response:
        # 1. Валидация бизнес-правил
        # 2. Получение данных через Data API
        # 3. Выполнение бизнес-логики
        # 4. Сохранение результата
        # 5. Возврат response
        pass
```

**Критерии завершения**:
- [ ] Новая бизнес-логика интегрирована
- [ ] Существующие endpoints продолжают работать
- [ ] Документация OpenAPI обновлена
- [ ] Тесты покрывают новый функционал

---

### Stage 4.4: Интеграция с UI (если требуется)

**Цель**: Обновить пользовательский интерфейс (Telegram Bot / Web)

**Для Telegram Bot**:

| # | Задача | Файлы | Требование |
|---|--------|-------|------------|
| 4.4.1 | Добавить новые handlers | handlers/{feature}.py | UI-* |
| 4.4.2 | Расширить клавиатуры | keyboards/{feature}.py | UI-* |
| 4.4.3 | Добавить FSM states (если нужно) | states/{feature}.py | — |
| 4.4.4 | Обновить меню/навигацию | handlers/menu.py | — |

**Критерии завершения**:
- [ ] Новый функционал доступен пользователю
- [ ] Навигация понятна
- [ ] Обработаны edge cases

---

### Stage 4.5: Тестирование интеграции

**Цель**: Убедиться что фича работает в контексте всего приложения

**Задачи**:

| # | Задача | Файлы | Покрытие |
|---|--------|-------|----------|
| 4.5.1 | Unit тесты нового функционала | tests/unit/*.py | ≥ 75% |
| 4.5.2 | Регрессионные тесты | tests/regression/*.py | Существующие сценарии |
| 4.5.3 | Integration тесты | tests/integration/*.py | Новые сценарии |
| 4.5.4 | Проверка обратной совместимости | — | API контракты |

**Критерии завершения**:
- [ ] Все существующие тесты проходят (регрессия)
- [ ] Coverage ≥ 75% для нового кода
- [ ] Integration тесты покрывают key flows
- [ ] API совместим со старыми клиентами

---

## 5. Порядок выполнения

```
Stage 4.1 (Инфраструктура)
    │
    ▼
Stage 4.2 (Data API)
    │
    ▼
Stage 4.3 (Business API)
    │
    ▼
Stage 4.4 (UI, если нужно)
    │
    ▼
Stage 4.5 (Тестирование)
```

---

## 6. Файлы для создания/изменения

### 6.1 Новые файлы

```
services/{service_name}/
├── src/
│   ├── domain/
│   │   ├── entities/{new_entity}.py          ← Новый
│   │   └── services/{feature}_service.py     ← Новый
│   ├── application/
│   │   └── services/{feature}_service.py     ← Новый
│   ├── api/v1/{feature}.py                   ← Новый
│   └── schemas/{feature}.py                  ← Новый
├── alembic/versions/{xxx}_add_{feature}.py   ← Новый
└── tests/
    └── unit/test_{feature}.py                ← Новый
```

### 6.2 Изменяемые файлы

```
services/{service_name}/
├── src/
│   ├── api/v1/router.py                      ← Добавить роутер
│   ├── infrastructure/http/data_client.py   ← Расширить методы
│   └── core/config.py                        ← Новые настройки (если нужно)
├── requirements.txt                          ← Новые зависимости
└── tests/conftest.py                         ← Новые fixtures

# Корневой уровень проекта:
docker-compose.yml                            ← Если новый сервис
.env.example                                  ← Новые переменные
```

---

## 7. Трассировка требований

| Требование | Stage | Задача | Файл | Тест |
|------------|-------|--------|------|------|
| FR-{XX1} | 4.2 | 4.2.1, 4.2.4 | {entity}.py | test_{entity}.py |
| FR-{XX2} | 4.3 | 4.3.2, 4.3.4 | {feature}_service.py | test_{feature}.py |
| NF-{XX1} | 4.5 | 4.5.3 | — | integration/*.py |

---

## 8. Риски интеграции

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Сломать существующий функционал | Средняя | Высокое | Полное регрессионное тестирование |
| Конфликты миграций | Низкая | Среднее | Проверить текущие миграции |
| Несовместимость API | Низкая | Высокое | Версионирование API (v1, v2) |
| Деградация производительности | Низкая | Среднее | Benchmark до и после |

---

## 9. Чек-лист перед реализацией

### FEATURE_PLAN_READY Checklist

**Анализ:**
- [ ] Существующая архитектура изучена
- [ ] Затрагиваемые сервисы определены
- [ ] Матрица влияния заполнена
- [ ] Обратная совместимость проверена

**Планирование:**
- [ ] Все stages определены
- [ ] Задачи детализированы
- [ ] Новые/изменяемые файлы перечислены
- [ ] Требования трассируются к задачам

**Риски:**
- [ ] Риски интеграции оценены
- [ ] Митигации определены

---

## 10. Подтверждение пользователя

> **ВНИМАНИЕ**: План требует подтверждения пользователя перед реализацией.

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚠️  ОЖИДАЕТСЯ ПОДТВЕРЖДЕНИЕ ПОЛЬЗОВАТЕЛЯ                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Пожалуйста, подтвердите:                                       │
│                                                                 │
│  1. Scope фичи корректен                                        │
│  2. Затрагиваемые сервисы определены верно                      │
│  3. Матрица влияния соответствует ожиданиям                     │
│  4. Риски приемлемы                                             │
│                                                                 │
│  После подтверждения будет установлено:                         │
│  gates.PLAN_APPROVED.passed = true                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
