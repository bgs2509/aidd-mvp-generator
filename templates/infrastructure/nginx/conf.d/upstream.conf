# =============================================================================
# Upstream конфигурация для {project_name} MVP
# =============================================================================
#
# Описание:
#   Определение backend-серверов для проксирования.
#   Единственный источник определений upstream.
#
# Архитектура:
#   nginx.conf (base) → include → upstream.conf → api-gateway.conf
#
# Именование контейнеров:
#   Формат: {context}-{type} (с дефисами, как в docker-compose)
#   Примеры: booking-api, booking-data, booking-bot
#
# Использование:
#   include /etc/nginx/conf.d/upstream.conf;
#

# =============================================================================
# Business API
# =============================================================================
# Основной API сервис с бизнес-логикой
upstream api_backend {
    server {context}-api:8000;
    keepalive 32;

    # Балансировка (если несколько инстансов)
    # least_conn;  # Выбирать сервер с минимумом соединений
    # ip_hash;     # Привязка клиента к серверу по IP
}

# =============================================================================
# Data API (PostgreSQL)
# =============================================================================
# Data-сервис для работы с PostgreSQL
upstream data_backend {
    server {context}-data:8001;
    keepalive 32;
}

# =============================================================================
# Data API (MongoDB) — раскомментировать при использовании
# =============================================================================
# upstream mongo_backend {
#     server {context}-mongo-data:8002;
#     keepalive 16;
# }

# =============================================================================
# Background Worker Health — раскомментировать при использовании
# =============================================================================
# upstream worker_backend {
#     server {context}-worker:8080;
#     keepalive 8;
# }

# =============================================================================
# WebSocket — раскомментировать при использовании
# =============================================================================
# upstream ws_backend {
#     server {context}-api:8000;
#     keepalive 64;
# }

# =============================================================================
# Параметры health check
# =============================================================================
# Примечание: активные health checks доступны только в Nginx Plus
# Для open-source версии используется passive health check:
#
# upstream api_backend {
#     server {context}-api:8000 max_fails=3 fail_timeout=30s;
# }
