# Функция: Уточнение пайплайна

> **Назначение**: Адаптация пайплайна под конкретный проект.

---

## Цель

На основе анализа кода и ограничений уточнить, какие этапы
и компоненты потребуются для реализации.

---

## Определение необходимых компонентов

### Для режима CREATE

```markdown
На основе PRD определить:

1. Нужен ли Business API?
   → Есть ли REST эндпоинты в требованиях?

2. Нужен ли Telegram Bot?
   → Есть ли требования к боту?

3. Нужен ли Background Worker?
   → Есть ли фоновые задачи?

4. Какой Data API нужен?
   → PostgreSQL для реляционных данных
   → MongoDB для документов
   → Оба?

5. Нужен ли Redis?
   → Кэширование?
   → Сессии?
   → Очереди?
```

### Для режима FEATURE

```markdown
На основе анализа кода:

1. Какие существующие сервисы затрагивает фича?
2. Нужны ли новые сервисы?
3. Нужны ли изменения в Data API?
4. Нужны ли новые эндпоинты?
5. Нужны ли новые модели данных?
```

---

## Матрица компонентов

### Стандартные компоненты MVP

| Компонент | Порт | Когда нужен |
|-----------|------|-------------|
| Business API | 8000 | Почти всегда (REST API) |
| Data API PG | 8001 | Реляционные данные |
| Data API Mongo | 8002 | Документы, логи |
| Telegram Bot | — | Если нужен бот |
| Background Worker | — | Фоновые задачи |
| Redis | 6379 | Кэш, сессии |
| PostgreSQL | 5432 | Основная БД |
| MongoDB | 27017 | Документная БД |

### Определение по требованиям

```
FR содержит "API", "REST", "эндпоинт"
  → Нужен Business API

FR содержит "Telegram", "бот", "команда"
  → Нужен Telegram Bot

FR содержит "фоновая", "периодически", "по расписанию"
  → Нужен Background Worker

FR содержит "хранить", "сохранять", "данные"
  → Нужен Data API

FR содержит "кэш", "быстрый доступ", "сессия"
  → Нужен Redis
```

---

## Уточнение этапов реализации

### CREATE Mode

```
Стандартный порядок:

1. Инфраструктура
   ├── docker-compose.yml
   ├── Makefile
   └── CI/CD

2. Data Service
   ├── Модели
   ├── Репозитории
   └── API

3. Business API (если нужен)
   ├── Сервисы
   ├── Роуты
   └── HTTP клиент

4. Telegram Bot (если нужен)
   ├── Handlers
   ├── Keyboards
   └── States

5. Background Worker (если нужен)
   ├── Task handlers
   └── Scheduler

6. Тесты
   ├── Unit
   └── Integration
```

### FEATURE Mode

```
Адаптированный порядок:

1. Изменения в Data API (если нужны)
   ├── Новые модели
   ├── Миграции
   └── Новые эндпоинты

2. Изменения в Business Services
   ├── Новые методы
   ├── Новые роуты
   └── Обновление HTTP клиента

3. Изменения в UI (если нужны)
   ├── Новые handlers
   └── Новые keyboards

4. Тесты
   ├── Тесты новой функции
   └── Регрессионные тесты
```

---

## Результат уточнения

```markdown
## Необходимые компоненты

| Компонент | Нужен | Комментарий |
|-----------|-------|-------------|
| Business API | Да | REST API для клиентов |
| Telegram Bot | Да | Уведомления ресторанам |
| Background Worker | Нет | Нет фоновых задач |
| Data API PG | Да | Хранение бронирований |
| Redis | Да | Кэширование поиска |

## План реализации

| # | Этап | Компоненты |
|---|------|------------|
| 1 | Инфраструктура | docker-compose, Makefile |
| 2 | Data API | booking_data |
| 3 | Business API | booking_api |
| 4 | Telegram Bot | booking_bot |
| 5 | Тесты | unit, integration |

## Зависимости между компонентами

booking_api ──HTTP──> booking_data
booking_bot ──HTTP──> booking_api
```

---

## Источники

| Документ | Описание |
|----------|----------|
| `.ai-framework/docs/reference/aidd-roles-reference.md` | Справочник ролей |
| `.ai-framework/docs/guides/conditional-stage-rules.md` | Условные правила |
