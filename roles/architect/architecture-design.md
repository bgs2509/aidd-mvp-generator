# Функция: Проектирование архитектуры

> **Назначение**: Создание архитектурного решения на основе PRD.

---

## Цель

Спроектировать архитектуру системы, которая удовлетворяет
функциональным и нефункциональным требованиям из PRD.

---

## Входные данные

| Артефакт | Путь | Описание |
|----------|------|----------|
| PRD | `ai-docs/docs/prd/{name}-prd.md` | Требования |
| Анализ кода | `ai-docs/docs/research/{name}-research.md` | Для FEATURE режима |
| Ворота | PRD_READY | Должны быть пройдены |

---

## Архитектурные принципы AIDD-MVP

### 1. HTTP-only доступ к данным

```
┌─────────────────┐     HTTP      ┌─────────────────┐
│  Business API   │ ───────────▶  │    Data API     │
│  (FastAPI)      │               │  (PostgreSQL)   │
└─────────────────┘               └─────────────────┘

ПРАВИЛО: Бизнес-сервисы НИКОГДА не обращаются к БД напрямую.
         Только через HTTP вызовы к Data API.
```

### 2. DDD + Hexagonal Architecture

```
┌────────────────────────────────────────────────────┐
│                     SERVICE                         │
├────────────────────────────────────────────────────┤
│  api/              ← Входящие адаптеры (REST)      │
│  ├── v1/                                           │
│  │   └── routes.py                                 │
│  └── dependencies.py                               │
├────────────────────────────────────────────────────┤
│  application/      ← Сервисы приложения            │
│  ├── services/                                     │
│  └── dtos/                                         │
├────────────────────────────────────────────────────┤
│  domain/           ← Бизнес-логика (ядро)          │
│  ├── entities/                                     │
│  ├── value_objects/                                │
│  └── services/                                     │
├────────────────────────────────────────────────────┤
│  infrastructure/   ← Исходящие адаптеры            │
│  ├── http/         (HTTP клиенты)                  │
│  └── messaging/    (очереди)                       │
└────────────────────────────────────────────────────┘
```

### 3. Один Event Loop на сервис

```
ПРАВИЛО: Каждый сервис владеет ОДНИМ event loop.
         Нельзя создавать дополнительные event loops.

FastAPI/Aiogram/Worker → asyncio.run() → один loop
```

---

## Процесс проектирования

### Шаг 1: Определить компоненты

На основе PRD определить необходимые сервисы:

```markdown
| Компонент | Нужен? | Обоснование |
|-----------|--------|-------------|
| Business API | ? | Есть ли REST эндпоинты в FR? |
| Data API (PG) | ? | Есть ли реляционные данные? |
| Data API (Mongo) | ? | Есть ли документы/логи? |
| Telegram Bot | ? | Есть ли FR для бота? |
| Background Worker | ? | Есть ли фоновые задачи? |
| Redis | ? | Нужен ли кэш/сессии? |
```

### Шаг 2: Спроектировать Data Model

```markdown
## Модели данных

### Entity: {Название}

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | UUID | Идентификатор | PK |
| ... | ... | ... | ... |

### Связи

{Entity1} 1──N {Entity2}
```

### Шаг 3: Определить API контракты

```markdown
## API контракты

### {Сервис} API

| Метод | Путь | Описание | Req ID |
|-------|------|----------|--------|
| POST | /api/v1/{resource} | Создание | FR-001 |
| GET | /api/v1/{resource}/{id} | Получение | FR-002 |
```

### Шаг 4: Определить взаимодействия

```markdown
## Диаграмма взаимодействий

User ──▶ Business API ──▶ Data API ──▶ PostgreSQL
              │
              └──▶ Telegram Bot ──▶ User (notifications)
```

---

## Шаблон архитектурного документа

```markdown
# Архитектура: {Название проекта}

**Версия**: 1.0
**Дата**: {YYYY-MM-DD}
**Автор**: AI Agent (Архитектор)

---

## 1. Обзор

### 1.1 Контекст
{Краткое описание системы}

### 1.2 Цели архитектуры
- {Цель 1}
- {Цель 2}

---

## 2. Компоненты системы

| Компонент | Тип | Порт | Описание |
|-----------|-----|------|----------|
| {name}_api | Business API | 8000 | REST API |
| {name}_data | Data API | 8001 | Доступ к PostgreSQL |
| {name}_bot | Telegram Bot | — | Уведомления |

---

## 3. Модели данных

### 3.1 ER диаграмма

{Текстовая диаграмма}

### 3.2 Описание моделей

{Таблицы с описанием полей}

---

## 4. API контракты

### 4.1 Business API

{Таблица эндпоинтов}

### 4.2 Data API

{Таблица эндпоинтов}

---

## 5. Взаимодействия

### 5.1 Основные потоки

{Диаграммы последовательности}

---

## 6. Инфраструктура

### 6.1 Docker сервисы

| Сервис | Образ | Порт | Зависимости |
|--------|-------|------|-------------|

### 6.2 Переменные окружения

| Переменная | Описание | Обязательна |
|------------|----------|-------------|

---

## 7. Решения и обоснования

| # | Решение | Альтернативы | Обоснование |
|---|---------|--------------|-------------|
| 1 | {Решение} | {Альтернативы} | {Почему выбрано} |
```

---

## Качественные ворота: ARCHITECTURE_READY

### Чек-лист

- [ ] Определены все необходимые компоненты
- [ ] Соблюдён принцип HTTP-only доступа к данным
- [ ] Определены модели данных
- [ ] Определены API контракты
- [ ] Контракты покрывают все FR
- [ ] Определены взаимодействия между компонентами
- [ ] Документ сохранён в `ai-docs/docs/architecture/`

---

## Источники

| Документ | Описание |
|----------|----------|
| `knowledge/architecture/improved-hybrid.md` | Гибридная архитектура |
| `knowledge/architecture/ddd-hexagonal.md` | DDD принципы |
| `knowledge/architecture/data-access.md` | HTTP-only доступ |
